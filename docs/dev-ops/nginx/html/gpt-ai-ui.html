<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>DeepSeek AI Chat</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- Tailwind -->
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 h-screen">
<div class="container mx-auto max-w-3xl h-screen flex flex-col py-4">

    <!-- é¡¶éƒ¨æ ‡é¢˜ -->
    <header class="mb-3 px-1">
        <h1 class="text-xl font-semibold text-gray-900">DeepSeek AI å¯¹è¯</h1>
        <p class="text-xs text-gray-500 mt-1">
            åŸºäº SpringBoot + Spring AI + Ollama çš„æµå¼åº”ç­” Demo
        </p>
    </header>

    <!-- æ¶ˆæ¯å®¹å™¨ -->
    <div id="messageContainer"
         class="flex-1 overflow-y-auto p-4 space-y-4 bg-white rounded-xl shadow border border-gray-200">
        <div class="flex justify-center">
            <div class="text-xs text-gray-400">
                ä½ å¥½ ğŸ‘‹ è¾“å…¥å†…å®¹åç‚¹å‡»ã€Œå‘é€ã€ï¼Œå¼€å§‹å’Œ AI å¯¹è¯
            </div>
        </div>
    </div>

    <!-- è¾“å…¥åŒºåŸŸ -->
    <div class="mt-3 bg-white rounded-xl shadow border border-gray-200 p-3">
        <div class="flex items-center space-x-2">
            <input
                    id="messageInput"
                    type="text"
                    placeholder="è¯·è¾“å…¥ä½ çš„é—®é¢˜ï¼Œä¾‹å¦‚ï¼šè§£é‡Šä¸€ä¸‹ Flux æµå¼æ¥å£æ˜¯ä»€ä¹ˆï¼Ÿ"
                    class="flex-1 px-3 py-2 text-sm border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                    onkeypress="handleKeyPress(event)"
            />
            <button
                    id="sendButton"
                    onclick="sendMessage()"
                    class="px-4 py-2 text-sm bg-blue-600 text-white rounded-lg hover:bg-blue-700 active:bg-blue-800 disabled:bg-blue-300 disabled:cursor-not-allowed transition-colors"
            >
                å‘é€
            </button>
        </div>
    </div>
</div>

<script>
    // ====== é…ç½® ======
    const BASE_URL = "http://localhost:8090/api/v1/ollama/generate_stream";
    const DEFAULT_MODEL = "deepseek-r1:1.5b";

    const messageContainer = document.getElementById("messageContainer");
    const messageInput = document.getElementById("messageInput");
    const sendButton = document.getElementById("sendButton");

    let currentEventSource = null;

    // æ·»åŠ ä¸€æ¡æ¶ˆæ¯åˆ°å®¹å™¨
    function addMessage(content, role) {
        const wrapper = document.createElement("div");
        const isUser = role === "user";

        wrapper.className = `flex ${isUser ? "justify-end" : "justify-start"}`;

        wrapper.innerHTML = `
      <div class="flex max-w-[85%] items-start space-x-2">
        ${isUser ? "" : `
          <div class="w-7 h-7 rounded-full bg-emerald-500 flex items-center justify-center text-white text-xs font-semibold select-none">
            AI
          </div>
        `}
        <div class="px-3 py-2 rounded-2xl shadow-sm text-sm leading-relaxed break-words ${
            isUser
                ? "bg-blue-600 text-white rounded-br-sm"
                : "bg-gray-100 text-gray-800 rounded-bl-sm"
        }">
          <span class="message-text">${content}</span>
        </div>
      </div>
    `;

        messageContainer.appendChild(wrapper);
        messageContainer.scrollTop = messageContainer.scrollHeight;

        // è¿”å›å†…éƒ¨æ–‡æœ¬ spanï¼Œæ–¹ä¾¿åç»­æµå¼æ›´æ–°
        return wrapper.querySelector(".message-text");
    }

    // æ›´æ–°æœ€åä¸€æ¡ AI æ¶ˆæ¯çš„å†…å®¹
    function updateLastAssistantMessage(htmlContent) {
        const children = messageContainer.children;
        if (!children.length) return;
        const last = children[children.length - 1];
        const span = last.querySelector(".message-text");
        if (span) {
            span.innerHTML = htmlContent;
            messageContainer.scrollTop = messageContainer.scrollHeight;
        }
    }

    // å…³é—­å½“å‰ SSE è¿æ¥
    function closeCurrentEventSource() {
        if (currentEventSource) {
            currentEventSource.close();
            currentEventSource = null;
        }
    }

    // å‘é€æ¶ˆæ¯
    function sendMessage() {
        const message = messageInput.value.trim();
        if (!message) return;

        // æ·»åŠ ç”¨æˆ·æ¶ˆæ¯
        addMessage(escapeHtml(message), "user");
        messageInput.value = "";

        // å…³é—­ä¸Šä¸€æ¬¡çš„ SSE è¿æ¥
        closeCurrentEventSource();

        // æ·»åŠ  AI å ä½æ¶ˆæ¯ï¼ˆæœ‰å°å…‰æ ‡åŠ¨ç”»ï¼‰
        const aiSpan = addMessage('<span class="animate-pulse">â–</span>', "assistant");

        // æ‹¼æ¥è¯·æ±‚ URL
        const apiUrl =
            BASE_URL +
            `?model=${encodeURIComponent(DEFAULT_MODEL)}&message=${encodeURIComponent(message)}`;

        // ç¦ç”¨æŒ‰é’®ï¼Œé¿å…é‡å¤ç‚¹å‡»
        sendButton.disabled = true;

        // å»ºç«‹ SSE è¿æ¥
        const eventSource = new EventSource(apiUrl);
        currentEventSource = eventSource;
        let buffer = "";

        eventSource.onmessage = (event) => {
            try {
                if (!event.data) return;

                const raw = JSON.parse(event.data);
                // æ—¢å…¼å®¹æ•°ç»„åŒ…è£¹ï¼Œä¹Ÿå…¼å®¹å•å¯¹è±¡
                const item = Array.isArray(raw) ? raw[0] : raw;
                if (!item || !item.result) return;

                const result = item.result;
                const output = result.output || {};
                const metadata = result.metadata || {};

                const contentChunk = output.content || "";
                const finishReason = metadata.finishReason;

                if (contentChunk) {
                    buffer += contentChunk;
                    // å¸¦ä¸€ä¸ªåŠ¨æ€å…‰æ ‡
                    aiSpan.innerHTML = escapeHtml(buffer) + ' <span class="animate-pulse">â–</span>';
                    messageContainer.scrollTop = messageContainer.scrollHeight;
                }

                if (finishReason === "STOP") {
                    eventSource.close();
                    currentEventSource = null;
                    sendButton.disabled = false;
                    // å»æ‰å…‰æ ‡
                    aiSpan.innerHTML = escapeHtml(buffer);
                }
            } catch (e) {
                console.error("è§£æ SSE æ•°æ®å¤±è´¥:", e);
            }
        };

        eventSource.onerror = (err) => {
            console.error("EventSource é”™è¯¯:", err);
            eventSource.close();
            currentEventSource = null;
            sendButton.disabled = false;

            // å¦‚æœè¿˜åªæ˜¯å ä½ç¬¦ï¼Œç»™å‡ºé”™è¯¯æç¤º
            if (aiSpan && aiSpan.textContent.trim() === "â–") {
                aiSpan.textContent = "æŠ±æ­‰ï¼Œè¿æ¥å‡ºé”™äº†ï¼Œè¯·ç¨åé‡è¯•ã€‚";
            }
        };
    }

    // å›è½¦å‘é€
    function handleKeyPress(event) {
        if (event.key === "Enter" && !event.shiftKey) {
            event.preventDefault();
            if (!sendButton.disabled) {
                sendMessage();
            }
        }
    }

    // ç®€å• HTML è½¬ä¹‰ï¼Œé˜²æ­¢ XSS
    function escapeHtml(str) {
        if (str == null) return "";
        return String(str)
            .replace(/&/g, "&amp;")
            .replace(/</g, "&lt;")
            .replace(/>/g, "&gt;")
            .replace(/"/g, "&quot;")
            .replace(/'/g, "&#039;");
    }
</script>
</body>
</html>
